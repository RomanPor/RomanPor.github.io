<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>New project</title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="css/uikit.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="icon" href="img/favicon.ico">
    <script src="js/uikit.js"></script>
</head>
<body style="position: relative">
<header class="head">
</header>

<div>
        <div  style="
      position: sticky;
      left: 0;
      top: 0;
      height: 100vh;
      width: 100%;
      background-repeat: no-repeat;
      background-position: top center;
      background-image: url('img/2.jpg');
      background-size: cover;"></div>
        <div class="uk-container" style="margin-top: -100vh">
            <div class="uk-flex-middle work-items uk-child-width-1-3@m uk-child-width-1-2" data-uk-grid="parallax: 150; margin: work-items_margin-top">
                <div>
                    <a href="#" class="work-item">
                        <div class="work-item__img">
                            <img src="img/2.jpg" data-hover="img/3.png" alt="">
                            <canvas height="464" width="378" class="clearfix"></canvas>
                        </div>
                        <div class="work-item__title">
                            UX/UI дизайн магазина Каffель
                        </div>
                        <div class="work-item__info">
                            <div>Интернет-магазин</div>
                            <div>2020</div>
                        </div>
                    </a>
                </div>
                <div>
                    <a href="#" class="work-item">
                        <div class="work-item__img">
                            <img src="img/2.jpg" data-hover="img/3.png" alt="">
                            <canvas height="464" width="378" class="clearfix"></canvas>
                        </div>
                        <div class="work-item__title">
                            UX/UI дизайн магазина Каffель
                        </div>
                        <div class="work-item__info">
                            <div>Интернет-магазин</div>
                            <div>2020</div>
                        </div>
                    </a>
                </div>
                <div>
                    
                    <a href="#" class="work-item">
                        <div class="work-item__img">
                            <img src="img/1.jpg" data-hover="img/5.jpg" alt="">
                            <canvas height="192" width="378" class="clearfix"></canvas>
                        </div>
                        <div class="work-item__title">
                            UX/UI дизайн магазина Каffель
                        </div>
                        <div class="work-item__info">
                            <div>Интернет-магазин</div>
                            <div>2020</div>
                        </div>
                    </a>
                </div>
                <div>
                    
                    <a href="#" class="work-item">
                        <div class="work-item__img">
                            <img src="img/1.jpg" data-hover="img/5.jpg" alt="">
                            <canvas height="192" width="378" class="clearfix"></canvas>
                        </div>
                        <div class="work-item__title">
                            UX/UI дизайн магазина Каffель
                        </div>
                        <div class="work-item__info">
                            <div>Интернет-магазин</div>
                            <div>2020</div>
                        </div>
                    </a>
                </div>
                <div>
                    
                    <a href="#" class="work-item">
                        <div class="work-item__img">
                            <img src="img/1.jpg" data-hover="img/5.jpg" alt="">
                            <canvas height="192" width="378" class="clearfix"></canvas>
                        </div>
                        <div class="work-item__title">
                            UX/UI дизайн магазина Каffель
                        </div>
                        <div class="work-item__info">
                            <div>Интернет-магазин</div>
                            <div>2020</div>
                        </div>
                    </a>
                </div>
                <div>
                    <a href="#" class="work-item">
                        <div class="work-item__img">
                            <img src="img/2.jpg" data-hover="img/3.png" alt="">
                            <canvas height="464" width="378" class="clearfix"></canvas>
                        </div>
                        <div class="work-item__title">
                            UX/UI дизайн магазина Каffель
                        </div>
                        <div class="work-item__info">
                            <div>Интернет-магазин</div>
                            <div>2020</div>
                        </div>
                    </a>
                </div>
                <div>
                    
                    <a href="#" class="work-item">
                        <div class="work-item__img">
                            <img src="img/1.jpg" data-hover="img/5.jpg" alt="">
                            <canvas height="192" width="378" class="clearfix"></canvas>
                        </div>
                        <div class="work-item__title">
                            UX/UI дизайн магазина Каffель
                        </div>
                        <div class="work-item__info">
                            <div>Интернет-магазин</div>
                            <div>2020</div>
                        </div>
                    </a>
                </div>
                <div>
                    <a href="#" class="work-item">
                        <div class="work-item__img">
                            <img src="img/2.jpg" data-hover="img/3.png" alt="">
                            <canvas height="464" width="378" class="clearfix"></canvas>
                        </div>
                        <div class="work-item__title">
                            UX/UI дизайн магазина Каffель
                        </div>
                        <div class="work-item__info">
                            <div>Интернет-магазин</div>
                            <div>2020</div>
                        </div>
                    </a>
                </div>
                <div>
                    
                    <a href="#" class="work-item">
                        <div class="work-item__img">
                            <img src="img/1.jpg" data-hover="img/5.jpg" alt="">
                            <canvas height="192" width="378" class="clearfix"></canvas>
                        </div>
                        <div class="work-item__title">
                            UX/UI дизайн магазина Каffель
                        </div>
                        <div class="work-item__info">
                            <div>Интернет-магазин</div>
                            <div>2020</div>
                        </div>
                    </a>
                </div>
                <div>
                    
                    <a href="#" class="work-item">
                        <div class="work-item__img">
                            <img src="img/1.jpg" data-hover="img/5.jpg" alt="">
                            <canvas height="192" width="378" class="clearfix"></canvas>
                        </div>
                        <div class="work-item__title">
                            UX/UI дизайн магазина Каffель
                        </div>
                        <div class="work-item__info">
                            <div>Интернет-магазин</div>
                            <div>2020</div>
                        </div>
                    </a>
                </div>
                <div>
                    
                    <a href="#" class="work-item">
                        <div class="work-item__img">
                            <img src="img/1.jpg" data-hover="img/5.jpg" alt="">
                            <canvas height="192" width="378" class="clearfix"></canvas>
                        </div>
                        <div class="work-item__title">
                            UX/UI дизайн магазина Каffель
                        </div>
                        <div class="work-item__info">
                            <div>Интернет-магазин</div>
                            <div>2020</div>
                        </div>
                    </a>
                </div>
                <div>
                    <a href="#" class="work-item">
                        <div class="work-item__img">
                            <img src="img/2.jpg" data-hover="img/3.png" alt="">
                            <canvas height="464" width="378" class="clearfix"></canvas>
                        </div>
                        <div class="work-item__title">
                            UX/UI дизайн магазина Каffель
                        </div>
                        <div class="work-item__info">
                            <div>Интернет-магазин</div>
                            <div>2020</div>
                        </div>
                    </a>
                </div>
                <div>
                    
                    <a href="#" class="work-item">
                        <div class="work-item__img">
                            <img src="img/1.jpg" data-hover="img/5.jpg" alt="">
                            <canvas height="192" width="378" class="clearfix"></canvas>
                        </div>
                        <div class="work-item__title">
                            UX/UI дизайн магазина Каffель
                        </div>
                        <div class="work-item__info">
                            <div>Интернет-магазин</div>
                            <div>2020</div>
                        </div>
                    </a>
                </div>
                <div>
                    
                    <a href="#" class="work-item">
                        <div class="work-item__img">
                            <img src="img/1.jpg" data-hover="img/5.jpg" alt="">
                            <canvas height="192" width="378" class="clearfix"></canvas>
                        </div>
                        <div class="work-item__title">
                            UX/UI дизайн магазина Каffель
                        </div>
                        <div class="work-item__info">
                            <div>Интернет-магазин</div>
                            <div>2020</div>
                        </div>
                    </a>
                </div>
                <div>
                    
                    <a href="#" class="work-item">
                        <div class="work-item__img">
                            <img src="img/1.jpg" data-hover="img/5.jpg" alt="">
                            <canvas height="192" width="378" class="clearfix"></canvas>
                        </div>
                        <div class="work-item__title">
                            UX/UI дизайн магазина Каffель
                        </div>
                        <div class="work-item__info">
                            <div>Интернет-магазин</div>
                            <div>2020</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
<canvas id="scene"></canvas>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.7.1/gsap.min.js"></script>
<script>
    const DURATION = 0.8;
    const SHADER = `#pragma glslify:
vec3 mod289(vec3 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec4 mod289(vec4 x) {
  return x - floor(x * (1.0 / 289.0)) * 289.0;
}

vec4 permute(vec4 x) {
     return mod289(((x*34.0)+1.0)*x);
}

vec4 taylorInvSqrt(vec4 r)
{
  return 1.79284291400159 - 0.85373472095314 * r;
}

float snoise3(vec3 v)
  {
  const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;
  const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);

// First corner
  vec3 i  = floor(v + dot(v, C.yyy) );
  vec3 x0 =   v - i + dot(i, C.xxx) ;

// Other corners
  vec3 g = step(x0.yzx, x0.xyz);
  vec3 l = 1.0 - g;
  vec3 i1 = min( g.xyz, l.zxy );
  vec3 i2 = max( g.xyz, l.zxy );

  //   x0 = x0 - 0.0 + 0.0 * C.xxx;
  //   x1 = x0 - i1  + 1.0 * C.xxx;
  //   x2 = x0 - i2  + 2.0 * C.xxx;
  //   x3 = x0 - 1.0 + 3.0 * C.xxx;
  vec3 x1 = x0 - i1 + C.xxx;
  vec3 x2 = x0 - i2 + C.yyy; // 2.0*C.x = 1/3 = C.y
  vec3 x3 = x0 - D.yyy;      // -1.0+3.0*C.x = -0.5 = -D.y

// Permutations
  i = mod289(i);
  vec4 p = permute( permute( permute(
             i.z + vec4(0.0, i1.z, i2.z, 1.0 ))
           + i.y + vec4(0.0, i1.y, i2.y, 1.0 ))
           + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));

// Gradients: 7x7 points over a square, mapped onto an octahedron.
// The ring size 17*17 = 289 is close to a multiple of 49 (49*6 = 294)
  float n_ = 0.142857142857; // 1.0/7.0
  vec3  ns = n_ * D.wyz - D.xzx;

  vec4 j = p - 49.0 * floor(p * ns.z * ns.z);  //  mod(p,7*7)

  vec4 x_ = floor(j * ns.z);
  vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)

  vec4 x = x_ *ns.x + ns.yyyy;
  vec4 y = y_ *ns.x + ns.yyyy;
  vec4 h = 1.0 - abs(x) - abs(y);

  vec4 b0 = vec4( x.xy, y.xy );
  vec4 b1 = vec4( x.zw, y.zw );

  //vec4 s0 = vec4(lessThan(b0,0.0))*2.0 - 1.0;
  //vec4 s1 = vec4(lessThan(b1,0.0))*2.0 - 1.0;
  vec4 s0 = floor(b0)*2.0 + 1.0;
  vec4 s1 = floor(b1)*2.0 + 1.0;
  vec4 sh = -step(h, vec4(0.0));

  vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;
  vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;

  vec3 p0 = vec3(a0.xy,h.x);
  vec3 p1 = vec3(a0.zw,h.y);
  vec3 p2 = vec3(a1.xy,h.z);
  vec3 p3 = vec3(a1.zw,h.w);

//Normalise gradients
  vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));
  p0 *= norm.x;
  p1 *= norm.y;
  p2 *= norm.z;
  p3 *= norm.w;

// Mix final noise value
  vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);
  m = m * m;
  return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1),
                                dot(p2,x2), dot(p3,x3) ) );
  }


uniform sampler2D u_map;
uniform sampler2D u_hovermap;

uniform float u_time;
uniform float u_alpha;


uniform vec2 u_res;
uniform vec2 u_ratio;
uniform vec2 u_hoverratio;
uniform vec2 u_mouse;
uniform float u_progressHover;
uniform float u_progressClick;

varying vec2 v_uv;

float circle(in vec2 _st, in float _radius, in float blurriness){
    vec2 dist = _st;
\t  return 1. - smoothstep(_radius-(_radius*blurriness), _radius+(_radius*blurriness), dot(dist,dist)*4.0);
}

void main() {
  vec2 resolution = u_res * PR;
  vec2 uv = v_uv;
  vec2 uv_h = v_uv;
  float time = u_time * 0.05;
  float progress = u_progressClick;
  float progressHover = u_progressHover;

  vec2 st = gl_FragCoord.xy / resolution.xy - vec2(.5);
  st.y *= resolution.y / resolution.x;

  vec2 mouse = vec2((u_mouse.x / u_res.x) * 2. - 1.,-(u_mouse.y / u_res.y) * 2. + 1.) * -.5;
  mouse.y *= resolution.y / resolution.x;

  float shape = (uv.x + uv.y - 2. + progressHover * 2.7 + progress * 2.7) * 2.;
  float offX = uv.x + uv.y;
  float offY = uv.y - uv.x;
  float n = snoise3(vec3(offX, offY, time) * 8.) * .5;

  float grd = 0.1 * progressHover;

  float sqr = 100. * ((smoothstep(0., grd, uv.x) - smoothstep(1. - grd, 1., uv.x)) * (smoothstep(0., grd, uv.y) - smoothstep(1. - grd, 1., uv.y))) - 10.;

  uv_h -= vec2(0.5);
  uv_h *= 1. - progressHover * 0.1;
  uv_h += vec2(0.5);

  uv_h *= u_hoverratio;

  uv -= vec2(0.5);
  uv *= 1. - progressHover * 0.2;
  uv *= u_ratio;
  uv += vec2(0.5);

  vec2 cpos = st + mouse;

  float c = circle(cpos, .04 * progressHover + progress * 0.8, 2.) * 50.;

  vec4 image = texture2D(u_map, uv);
  vec4 hover = texture2D(u_hovermap, uv_h + mouse * 0.1 * progressHover);

  float pct = smoothstep(.99, 1., n + shape);

  float finalMask = smoothstep(.0, .1, sqr - c);

  vec4 finalImage = mix(image, hover, pct);

  gl_FragColor = vec4(finalImage.rgb, u_alpha * finalMask) ;
}`;
    const MOBILE = 1025;
    const multiplyMatrixAndPoint = (matrix, point) => {
        const c0r0 = matrix[0]
        const c1r0 = matrix[1]
        const c0r1 = matrix[2]
        const c1r1 = matrix[3]
        const x = point[0]
        const y = point[1]
        return [Math.abs(x * c0r0 + y * c0r1), Math.abs(x * c1r0 + y * c1r1)]
    }
    const rotateMatrix = (a) => [Math.cos(a), -Math.sin(a), Math.sin(a), Math.cos(a)]
    const getRatio = ({ x: w, y: h }, { width, height }, r = 0) => {
        const m = multiplyMatrixAndPoint(rotateMatrix(THREE.Math.degToRad(r)), [w, h])
        const originalRatio = {
            w: m[0] / width,
            h: m[1] / height,
        }

        const coverRatio = 1 / Math.max(originalRatio.w, originalRatio.h)

        return new THREE.Vector2(
            originalRatio.w * coverRatio,
            originalRatio.h * coverRatio,
        )
    }

    class Tile {

        constructor($el, scene, duration, fragmentShader) {
            this.scene = scene
            this.el = $el
            this.duration = duration || DURATION
            this.mainImage = this.el.querySelector('img')
            this.images = []
            this.sizes = new THREE.Vector2(0, 0)
            this.offset = new THREE.Vector2(0, 0)

            this.scroll = 0
            this.prevScroll = 0
            this.delta = 0

            this.vertexShader = `varying vec2 v_uv;
void main() {
v_uv = uv;
vec3 pos = position;

gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
}`

            this.fragmentShader = fragmentShader || SHADER

            this.clock = new THREE.Clock()

            this.mouse = new THREE.Vector2(0, 0)
            this.isHovering = false

            this.loader = new THREE.TextureLoader()
            this.preload([this.mainImage.src, this.mainImage.dataset.hover], () => { this.initTile() })


            this.bindEvent()
        }

        bindEvent() {
            window.addEventListener('resize', () => { this.onResize() })
            window.addEventListener('mousemove', (e) => { this.onMouseMove(e) })

            this.el.addEventListener('mouseenter', () => { this.onPointerEnter() })
            this.el.addEventListener('mouseleave', () => { this.onPointerLeave() })

            window.addEventListener('scroll', () => this.onScroll())
        }

        /* Handlers
        --------------------------------------------------------- */

        onScroll() {
            this.scroll = Math.floor(window.scrollY);
        }

        onPointerEnter() {
            this.isHovering = true

            if (!this.mesh) return

            TweenMax.to(this.uniforms.u_progressHover, this.duration, {
                value: 1,
                ease: Power2.easeInOut,
            })
        }

        onPointerLeave() {
            if (!this.mesh) return

            TweenMax.to(this.uniforms.u_progressHover, this.duration, {
                value: 0,
                ease: Power2.easeInOut,
                onComplete: () => {
                    this.isHovering = false
                },
            })
        }

        onResize() {
            this.getBounds()

            if (!this.mesh) return

            this.mesh.scale.set(this.sizes.x, this.sizes.y, 1)
            this.uniforms.u_res.value.set(window.innerWidth, window.innerHeight)
        }

        onMouseMove(event) {
            TweenMax.to(this.mouse, 0.5, {
                x: event.clientX,
                y: event.clientY,
            })
        }


        /* Actions
        --------------------------------------------------------- */

        initTile() {
            const texture = this.images[0]
            const hoverTexture = this.images[1]

            this.getBounds()

            this.uniforms = {
                u_alpha: { value: 1 },
                u_map: { type: 't', value: texture },
                u_ratio: { value: getRatio(this.sizes, texture.image) },
                u_hovermap: { type: 't', value: hoverTexture },
                u_hoverratio: { value: getRatio(this.sizes, hoverTexture.image) },
                u_shape: { value: this.images[2] },
                u_mouse: { value: this.mouse },
                u_progressHover: { value: 0 },
                u_progressClick: { value: 0 },
                u_time: { value: this.clock.getElapsedTime() },
                u_res: { value: new THREE.Vector2(window.innerWidth, window.innerHeight) },
            }

            this.geometry = new THREE.PlaneBufferGeometry(1, 1, 1, 1)

            this.material = new THREE.ShaderMaterial({
                uniforms: this.uniforms,
                vertexShader: this.vertexShader,
                fragmentShader: this.fragmentShader,
                transparent: true,
                defines: {
                    PI: Math.PI,
                    PR: window.devicePixelRatio.toFixed(1),
                },
            })

            this.mesh = new THREE.Mesh(this.geometry, this.material)

            this.mesh.position.x = this.offset.x
            this.mesh.position.y = this.offset.y

            this.mesh.scale.set(this.sizes.x, this.sizes.y, 1)

            this.scene.mainScene.add(this.mesh)
        }

        mainImageInvisible() {
            this.mainImage.classList.add('is-loaded')
        }

        mainImageVisible() {
            this.mainImage.classList.remove('is-loaded')
        }

        move() {
            if (!this.mesh) return
            this.getBounds()

            TweenMax.set(this.mesh.position, {
                x: this.offset.x,
                y: this.offset.y,
            })

            TweenMax.to(this.mesh.scale, 0.5, {
                x: this.sizes.x - this.delta,
                y: this.sizes.y - this.delta,
                z: 1,
            })
        }

        update() {
            this.delta = Math.abs((this.scroll - this.prevScroll))

            if (!this.mesh) return

            this.move()

            this.prevScroll = this.scroll

            if (!this.isHovering) return
            this.uniforms.u_time.value += this.clock.getDelta()
        }


        /* Values
        --------------------------------------------------------- */

        getBounds() {
            const { width, height, left, top } = this.mainImage.getBoundingClientRect()

            if (!this.sizes.equals(new THREE.Vector2(width, height))) {
                this.sizes.set(width, height)
            }

            if (!this.offset.equals(new THREE.Vector2(left - window.innerWidth / 2 + width / 2, -top + window.innerHeight / 2 - height / 2))) {
                this.offset.set(left - window.innerWidth / 2 + width / 2, -top + window.innerHeight / 2 - height / 2)
            }
        }

        preload($els, allImagesLoadedCallback) {
            let loadedCounter = 0
            const toBeLoadedNumber = $els.length
            const preloadImage = ($el, anImageLoadedCallback) => {
                const image = this.loader.load($el, anImageLoadedCallback);
                image.center.set(0.5, 0.5)
                this.images.push(image)
            }

            $els.forEach(($el) => {
                preloadImage($el, () => {
                    loadedCounter += 1
                    if (loadedCounter === toBeLoadedNumber) {
                        allImagesLoadedCallback()
                    }
                })
            })
        }

    }

    class Scene {
        constructor($scene) {
            this.container = $scene
            this.tiles = []
            this.W = window.innerWidth
            this.H = window.innerHeight
            this.perspective = 800
            this.mouse = new THREE.Vector2(0, 0)

            this.start()

            this.bindEvent()
        }

        bindEvent() {
            window.addEventListener('resize', () => { this.onResize() })
        }

        addTiles(selector, duration, shader) {
            const $tiles = document.querySelectorAll(selector)
            this.tiles = [...this.tiles, ...Array.from($tiles).map(($el) => new Tile($el, this, duration, shader))]
            this.adaptive()
        }


        start() {
            this.mainScene = new THREE.Scene()
            this.initCamera()
            this.initLights()

            this.renderer = new THREE.WebGLRenderer({
                canvas: this.container,
                alpha: true,
            })
            this.renderer.setSize(this.W, this.H)
            this.renderer.setPixelRatio(window.devicePixelRatio)

            this.update()
            this.adaptive()
        }

        initCamera() {
            const fov = (180 * (2 * Math.atan(this.H / 2 / this.perspective))) / Math.PI

            this.camera = new THREE.PerspectiveCamera(fov, this.W / this.H, 1, 10000)
            this.camera.position.set(0, 0, this.perspective)
        }

        initLights() {
            const ambientlight = new THREE.AmbientLight(0xffffff, 2)
            this.mainScene.add(ambientlight)
        }


        /* Handlers
        --------------------------------------------------------- */

        onResize() {
            this.adaptive()
            this.W = window.innerWidth
            this.H = window.innerHeight

            this.camera.aspect = this.W / this.H

            this.camera.updateProjectionMatrix()
            this.renderer.setSize(this.W, this.H)
        }

        /* Actions
        --------------------------------------------------------- */
        adaptive() {
            const width = document.documentElement.clientWidth;
            if (width < MOBILE) {
                this.tiles.forEach((it) => it.mainImageVisible())
                this.container.style.display = 'none'
                cancelAnimationFrame(this.animation);
            } else {
                this.tiles.forEach((it) => it.mainImageInvisible())
                this.container.style.display = 'block'
                this.update()
            }
        }


        update() {
            this.animation = requestAnimationFrame(this.update.bind(this))
            this.tiles.forEach((tile) => {
                tile.update()
            })
            this.renderer.render(this.mainScene, this.camera)
        }
    }

    const initScene = (scene) => {
        const canvas = new Scene(document.querySelector(scene));
        return (selector, duration , shader) => {
            canvas.addTiles(selector, duration, shader);
        }
    }

    initScene( '#scene')('.work-item');
</script>

</body>
</html>
